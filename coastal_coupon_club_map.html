<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Coastal Coupon Club Map</title>
  <style>
    html, body {
      margin: 0;
      font-family: 'ABeeZee', sans-serif;
      background-color: #fefef8;
    }

    #container {
      display: flex;
      flex-direction: row;
      gap: 1rem;
      padding: 1rem;
      box-sizing: border-box;
    }

    #map {
      flex: 2;
      border: 5px solid #222d47;
      border-radius: 16px;
      height: 600px;
      min-width: 300px;
    }

    #sidebar {
      flex: 1.2;
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }

    #searchBox, #categoryFilter {
      width: 100%;
      padding: 14px 18px;
      font-size: 16px;
      border: 3px solid #222d47;
      border-radius: 12px;
      background-color: #fffdf3;
      color: #222d47;
      box-sizing: border-box;
    }

    #categoryFilter {
      background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='16' height='16' fill='%23222d47' viewBox='0 0 16 16'%3E%3Cpath d='M1.5 5.5l6.5 6 6.5-6H1.5z'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      background-size: 12px;
    }

    #businessList {
      border: 3px solid #222d47;
      border-radius: 12px;
      padding: 14px;
      background-color: #fffdf3;
      overflow-y: auto;
      max-height: 600px;
    }

    .business {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      margin-bottom: 1.25rem;
      border-bottom: 1px solid #ddd;
      padding-bottom: 1.25rem;
      cursor: pointer;
    }

    .business img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .business-info {
      flex-grow: 1;
    }

    .business-name {
      font-size: 15px;
      font-weight: bold;
      margin-bottom: 4px;
    }

    .business-address {
      font-size: 13px;
      color: #777;
      margin-bottom: 4px;
    }

    .business-deal {
      background-color: #ffeaae;
      color: #222d47;
      font-weight: bold;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 6px;
      display: inline-block;
    }

    .visit-link {
      display: inline-block;
      background-color: #222d47;
      color: white;
      text-decoration: none;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
    }

    /* Mobile Styling */
    @media (max-width: 768px) {
      #container {
        flex-direction: column;
        padding: 1rem;
      }

      #map {
        height: 300px;
        width: 100%;
        border-radius: 16px;
      }

      #sidebar {
        width: 100%;
        gap: 1rem;
      }

      #businessList {
        max-height: none;
        padding: 12px;
      }

      .business {
        flex-direction: row;
        align-items: center;
        gap: 10px;
      }

      .business-info {
        width: 100%;
      }

      .business img {
        width: 36px;
        height: 36px;
      }

      .business-name {
        font-size: 14px;
      }

      .business-address {
        font-size: 12px;
      }

      .business-deal {
        font-size: 12px;
        padding: 2px 6px;
      }

      .visit-link {
        font-size: 12px;
        padding: 5px 10px;
      }
    }
  </style>
  <link href="https://fonts.googleapis.com/css2?family=ABeeZee&display=swap" rel="stylesheet">
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBCweTO479qWGF9W5PX5NlxtfPWav5LcZQ"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
</head>
<body>
  <div id="container">
    <div id="map"></div>
    <div id="sidebar">
      <input type="text" id="searchBox" placeholder="Search businesses...">
      <select id="categoryFilter">
        <option value="">All Categories</option>
      </select>
      <div id="businessList"></div>
    </div>
  </div>

  <script>
    let map;
    let allBusinesses = [];
    let markers = [];

    const fallbackLogo = "https://static.wixstatic.com/media/838f49_e6ac8637cea24f1f9ec00984ba010740~mv2.png";

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 30.4, lng: -86.86 },
        zoom: 13,
      });
    }

    function fetchData() {
      Papa.parse("https://docs.google.com/spreadsheets/d/e/2PACX-1vR_vRTR0dSR-AV_5GXfgqFUY52CULx3WySkZLgVP80rKp7Qna9E6fKi4HAObARD9tLmdndTnuo_b9rm/pub?output=csv", {
        download: true,
        header: true,
        complete: function(results) {
          allBusinesses = results.data.filter(row => row["Business Name"] && row.Address);
          const categories = [...new Set(allBusinesses.map(b => b.Category).filter(Boolean))];
          const categorySelect = document.getElementById('categoryFilter');
          categorySelect.innerHTML = '<option value="">All Categories</option>';
          categories.forEach(cat => {
            const opt = document.createElement('option');
            opt.value = cat;
            opt.textContent = cat;
            categorySelect.appendChild(opt);
          });
          renderList();
        }
      });
    }

    function clearMarkers() {
      markers.forEach(marker => marker.setMap(null));
      markers = [];
    }

    function renderList(filter = '', category = '') {
      const businessList = document.getElementById('businessList');
      businessList.innerHTML = '';
      let markerMap = {};
      clearMarkers();
      let firstGeoLocation = null;

      allBusinesses.forEach(biz => {
        if (!biz["Business Name"].toLowerCase().includes(filter.toLowerCase())) return;
        if (category && biz.Category !== category) return;

        const logo = biz["Logo URL"] || fallbackLogo;

        const div = document.createElement('div');
        div.className = 'business';
        div.innerHTML = `
          <img src="${logo}" alt="${biz["Business Name"]}" />
          <div class="business-info">
            <div class="business-name">${biz["Business Name"]}</div>
            <div class="business-address">${biz.Address}</div>
            <div class="business-deal">${biz["Deal Description"]}</div>
            <a href="${biz["Website URL"]}" target="_blank" class="visit-link">Visit Site</a>
          </div>
        `;
        div.style.cursor = 'pointer';
        businessList.appendChild(div);

        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: biz.Address }, (results, status) => {
          if (status === 'OK') {
            if (!firstGeoLocation) {
              firstGeoLocation = results[0].geometry.location;
              map.setCenter(firstGeoLocation);
            }

            const marker = new google.maps.Marker({
              position: results[0].geometry.location,
              map: map,
              title: biz["Business Name"],
              icon: {
                url: logo,
                scaledSize: new google.maps.Size(40, 40),
                anchor: new google.maps.Point(20, 20)
              }
            });

            markers.push(marker);
            markerMap[biz["Business Name"]] = marker;

            const infowindow = new google.maps.InfoWindow({
              content: `
                <div style='font-family: ABeeZee, sans-serif; font-size: 14px; max-width: 200px;'>
                  <div style='font-size: 16px; font-weight: bold;'>${biz["Business Name"]}</div>
                  <img src="${logo}" style='width:60px; height:60px; border-radius:8px; margin:6px 0;' />
                  <div style='background:#ffeaae; color:#222d47; font-weight:bold; padding:2px 6px; border-radius:4px; font-size:13px; display:inline-block; margin:4px 0;'>${biz["Deal Description"]}</div><br/>
                  <a href="${biz["Website URL"]}" target="_blank" style="display:inline-block; background-color:#222d47; color:white; text-decoration:none; padding:4px 8px; border-radius:4px; font-size:12px;">Visit Site</a>
                </div>
              `
            });

            marker.addListener('click', () => {
              infowindow.open(map, marker);
            });

            div.addEventListener('click', () => {
              map.setCenter(marker.getPosition());
              map.setZoom(15);
              google.maps.event.trigger(marker, 'click');
            });
          }
        });
      });
    }

    document.getElementById('searchBox').addEventListener('input', (e) => {
      renderList(e.target.value, document.getElementById('categoryFilter').value);
    });

    document.getElementById('categoryFilter').addEventListener('change', (e) => {
      renderList(document.getElementById('searchBox').value, e.target.value);
    });

    window.onload = () => {
      setTimeout(() => {
        initMap();
        fetchData();
      }, 500);
    };
  </script>
</body>
</html>
